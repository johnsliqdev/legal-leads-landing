// Google Apps Script - Fixed Version with CORS Headers
// Replace all code in your script.google.com project with this

function doPost(e) {
  try {
    // Log the entire event for debugging
    Logger.log(' doPost event: ' + JSON.stringify(e));
    
    if (!e || !e.postData) {
      Logger.log('No postData found in event');
      return ContentService.createTextOutput(JSON.stringify({error: 'No postData found'}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const data = JSON.parse(e.postData.contents);
    Logger.log('Parsed data: ' + JSON.stringify(data));
    
    if (data.action === 'append') {
      appendToSheet(data.data);
      Logger.log('Data appended successfully');
      return ContentService.createTextOutput(JSON.stringify({success: true}))
        .setMimeType(ContentService.MimeType.JSON);
    } else if (data.action === 'clear') {
      clearSheet();
      Logger.log('Sheet cleared successfully');
      return ContentService.createTextOutput(JSON.stringify({success: true}))
        .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    Logger.log('Error in doPost: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    // Handle GET requests with data parameter
    if (e.parameter.data) {
      const data = JSON.parse(e.parameter.data);
      Logger.log('GET request with data: ' + JSON.stringify(data));
      
      if (data.action === 'append') {
        appendToSheet(data.data);
        Logger.log('Data appended via GET request');
        return ContentService.createTextOutput(JSON.stringify({success: true}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    if (e.parameter.action === 'get') {
      const sheetData = getSheetData();
      return ContentService.createTextOutput(JSON.stringify(sheetData))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Default response
    return ContentService.createTextOutput(JSON.stringify({status: 'Google Sheets API is working'}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log('Error in doGet: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doOptions(e) {
  // Handle preflight requests
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT);
}

function appendToSheet(submissionData) {
  try {
    const sheet = SpreadsheetApp.openById('15SwhJnQK5Y9v8A6lpQ2Yxcb-rKwjVSDga5twy6DL7Os')
      .getSheetByName('PI Lead Submissions') || 
      SpreadsheetApp.openById('15SwhJnQK5Y9v8A6lpQ2Yxcb-rKwjVSDga5twy6DL7Os')
      .getSheets()[0];
    
    const timestamp = new Date();
    const row = [
      timestamp.toISOString(),
      timestamp.toLocaleDateString(),
      timestamp.toLocaleTimeString(),
      submissionData.firstName || '',
      submissionData.lastName || '',
      submissionData.email || '',
      submissionData.phone || '',
      submissionData.lawFirm || '',
      submissionData.currentCpl || '',
      submissionData.savings || '',
      submissionData.id || Date.now().toString()
    ];
    
    sheet.appendRow(row);
    Logger.log('Data appended successfully: ' + JSON.stringify(submissionData));
  } catch (error) {
    Logger.log('Error in appendToSheet: ' + error.toString());
    throw error;
  }
}

function clearSheet() {
  try {
    const sheet = SpreadsheetApp.openById('15SwhJnQK5Y9v8A6lpQ2Yxcb-rKwjVSDga5twy6DL7Os')
      .getSheetByName('PI Lead Submissions') || 
      SpreadsheetApp.openById('15SwhJnQK5Y9v8A6lpQ2Yxcb-rKwjVSDga5twy6DL7Os')
      .getSheets()[0];
    
    // Clear all data except headers
    sheet.getRange('A2:Z').clearContent();
    
    Logger.log('Sheet cleared successfully');
    return true;
  } catch (error) {
    Logger.log('Error in clearSheet: ' + error.toString());
    return false;
  }
}

function getSheetData() {
  try {
    const sheet = SpreadsheetApp.openById('15SwhJnQK5Y9v8A6lpQ2Yxcb-rKwjVSDga5twy6DL7Os')
      .getSheetByName('PI Lead Submissions') || 
      SpreadsheetApp.openById('15SwhJnQK5Y9v8A6lpQ2Yxcb-rKwjVSDga5twy6DL7Os')
      .getSheets()[0];
    
    const data = sheet.getDataRange().getValues();
    Logger.log('Sheet data retrieved: ' + JSON.stringify(data));
    
    if (data.length < 2) {
      return [];
    }
    
    const headers = data[0];
    const rows = data.slice(1);
    
    return rows.map((row, index) => {
      const obj = {};
      headers.forEach((header, i) => {
        obj[header] = row[i] || '';
      });
      return obj;
    });
  } catch (error) {
    Logger.log('Error in getSheetData: ' + error.toString());
    throw error;
  }
}

// Test function - run this to test the connection
function testConnection() {
  try {
    const sheet = SpreadsheetApp.openById('15SwhJnQK5Y9v8A6lpQ2Yxcb-rKwjVSDga5twy6DL7Os');
    Logger.log('Connection successful: ' + sheet.getName());
  } catch (error) {
    Logger.log('Connection failed: ' + error.toString());
  }
}

// Test function - run this to test the connection
function testConnection() {
  try {
    const sheet = SpreadsheetApp.openById('15SwhJnQK5Y9v8A6lpQ2Yxcb-rKwjVSDga5twy6DL7Os');
    Logger.log('Successfully connected to sheet: ' + sheet.getName());
    return 'Connection successful';
  } catch (error) {
    Logger.log('Connection failed: ' + error.toString());
    return 'Connection failed: ' + error.toString();
  }
}
